<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ball Game</title>
  </head>
  <body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="ui">
      <button id="startBtn">‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <div id="endScreen" style="display: none">
        <h2 id="endMessage"></h2>
        <button id="restartBtn">üîÅ –°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
      </div>
    </div>

    <div id="levelDisplay">Level 1</div>
    <div id="VersionDisplay">"FightingBalls" @IFilkov</div>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
        font-family: sans-serif;
        background-color: #eee;
      }
      canvas {
        width: 100%;
        height: 100%;
        background-color: #eee;
        display: block;
        margin: auto;
      }

      #ui {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #startBtn,
      #restartBtn {
        width: 200px;
        height: 200px;
        font-size: 20px;
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: #4caf50;
        color: white;
        border-radius: 50%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: background 0.3s;
        pointer-events: auto;
      }

      #startBtn:hover,
      #restartBtn:hover {
        background: #45a049;
      }

      #startBtn {
        pointer-events: auto;
      }

      #endScreen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        animation: fadeInZoom 0.6s ease forwards;
        pointer-events: auto;
        z-index: 10;
      }

      #endMessage {
        font-size: 28px;
        margin-bottom: 25px;
        color: #333;
        text-align: center;
      }

      #levelDisplay {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 24px;
        font-weight: bold;
        color: blue;
        font-family: sans-serif;
        z-index: 10;
      }
      #VersionDisplay {
        position: fixed;
        bottom: 10px;
        right: -100%; /* –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞ —ç–∫—Ä–∞–Ω–æ–º */
        white-space: nowrap;
        font-family: Arial, sans-serif;
        font-size: 42px;
        color: #00aaff;
        z-index: 1000;
        animation: marquee 10s linear infinite;
        pointer-events: none;
      }

      @keyframes marquee {
        0% {
          right: -100%;
        }
        100% {
          right: 100%;
          transform: translateX(-100vw);
        }
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
      #VersionDisplay.hidden {
        display: none;
      }

      @keyframes fadeInZoom {
        from {
          opacity: 0;
          transform: scale(0.5);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      const startBtn = document.getElementById("startBtn");
      const endScreen = document.getElementById("endScreen");
      const endMessage = document.getElementById("endMessage");
      const restartBtn = document.getElementById("restartBtn");

      let selectionPhase = false;
      let selectionTimer = 240; // 4 —Å–µ–∫—É–Ω–¥—ã
      let gameStarted = false;
      let winnerBall = null;
      let enemyTeamMode = false;
      let isInitialStart = true;

      startBtn.onclick = () => {
        startBtn.style.display = "none";
        document.getElementById("VersionDisplay").classList.add("hidden");
        isInitialStart = false;
        currentLevel === 1;
        startGame();
      };

      function updateLevelDisplay() {
        document.getElementById(
          "levelDisplay"
        ).textContent = `Level ${currentLevel}`;
      }

      let selectionStartTime = Date.now();
      let selectedBalls = [];
      let playerSelectedBalls = [];

      class Ball {
        constructor(x, y, type) {
          this.x = x;
          this.y = y;
          this.radius = 15;
          this.baseRadius = 15;
          this.scale = 1;
          this.targetScale = 1;
          this.color = this.getColorByType(type);
          this.type = type;
          this.dx = 0;
          this.dy = 0;
          this.score = 0;
          this.id = Math.random().toString(36).substr(2, 9);
          this.hp = 200;
          this.mode = "toCenter"; // –≤–∞—Ä–∏–∞–Ω—Ç—ã: 'toCenter', 'spread'
          this.spreadTimer = 0;
          this.selectedByPlayer = false;
          this.collisionSurvived = 0;
          this.bonusGiven = false;
          this.auraTimer = 0;
          this.auraColor = null;
          this.isDragging = false;
          this.offsetX = 0;
          this.offsetY = 0;
          this.visualRadius = this.baseRadius + this.score * 2;
        }
        activateAura(duration = 400) {
          this.auraTimer = duration;

          // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä —É–º–µ–Ω—å—à–µ–Ω–∏—è
          const interval = setInterval(() => {
            this.auraTimer -= 100;
            if (this.auraTimer <= 0) {
              this.auraTimer = 0;
              clearInterval(interval);
            }
          }, 100);
        }

        getColorByType(type) {
          switch (type) {
            case "A":
              return "green";
            case "B":
              return "orange";
            case "D":
              return "purple";
            case "G":
              return "pink";
          }
        }

        draw() {
          // üåü –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –∞—É—Ä–∞ ‚Äî —Ä–∏—Å—É–µ–º –∂—ë–ª—Ç—É—é –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å
          // if (this.auraTimer > 0) {
          //   ctx.beginPath();
          //   ctx.arc(this.x, this.y, this.radius + 5, 0, Math.PI * 2);
          //   ctx.strokeStyle = "orange";
          //   ctx.lineWidth = 2;
          //   ctx.stroke();
          //   ctx.closePath();
          // }

          if (this.selectedByPlayer) {
            ctx.fillStyle = "green";
            ctx.font = "26px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("üíÄ", this.x, this.y);
          }
          if (this.hp <= 0) {
            // –†–∏—Å—É–µ–º –≥—Ä–æ–±–∏–∫
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.moveTo(this.x - 15, this.y); // –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª
            ctx.arcTo(this.x + 15, this.y, this.x + 15, this.y + 40, 10); // –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π —É–≥–æ–ª
            ctx.lineTo(this.x + 15, this.y + 40);
            ctx.lineTo(this.x - 15, this.y + 40);
            ctx.closePath();
            ctx.fill();

            // –ù–∞–¥–ø–∏—Å—å RIP
            ctx.fillStyle = "white";
            ctx.font = "12px Arial";
            ctx.textAlign = "center";
            ctx.fillText("RIP", this.x, this.y + 25);
          } else {
            // –†–∏—Å—É–µ–º –∂–∏–≤–æ–π —à–∞—Ä
            ctx.save(); // üí° –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–æ–º
            ctx.translate(this.x, this.y);
            this.scale += (this.targetScale - this.scale) * 0.1;
            ctx.scale(this.scale, this.scale);
            ctx.beginPath();
            ctx.arc(0, 0, this.baseRadius, 0, Math.PI * 2); // ‚¨ÖÔ∏è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã 0,0
            ctx.fillStyle = this.selectedByPlayer ? "lightblue" : this.color;
            ctx.fill();
            ctx.stroke();
            ctx.restore(); // üí° –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –∏ –ø–æ–∑–∏—Ü–∏—é

            if (enemyTeamMode && !this.selectedByPlayer && this.hp > 0) {
              ctx.fillStyle = "purple";
              ctx.font = "12px Arial";
              ctx.textAlign = "center";
              ctx.fillText("Team", this.x, this.y - this.radius - 22);
            }

            // üåü –ê—É—Ä–∞: –∂—ë–ª—Ç–∞—è –∏–ª–∏ —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏
            if (this.auraTimer > 0) {
              ctx.beginPath();
              ctx.arc(this.x, this.y, this.radius + 5, 0, Math.PI * 2);
              ctx.strokeStyle = this.auraColor || "yellow";
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.closePath();
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—á–∫–∏
            ctx.fillStyle = "black";
            ctx.font = "10px Arial";
            ctx.textAlign = "center";
            ctx.fillText(this.score, this.x, this.y + 3);
          }
          // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ HP –Ω–∞–¥ —à–∞—Ä–∏–∫–æ–º
          ctx.font = "14px Arial";
          ctx.fillStyle = "black";
          ctx.textAlign = "center";
          ctx.fillText(`‚ù§Ô∏è${this.hp}`, this.x, this.y - this.radius - 8);
        }

        update() {
          if (this.hp <= 0) return; // –ú—ë—Ä—Ç–≤—ã–π —à–∞—Ä–∏–∫ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è

          balls.forEach((balls) => {
            if (balls.auraTimer > 0) {
              balls.auraTimer--;
            }
          });

          // if (!this.isDragging) {
          //   // –°—Ç—Ä–µ–º–∏—Ç—Å—è –∫ —Ü–µ–Ω—Ç—Ä—É
          //   const centerX = canvas.width / 2;
          //   const centerY = canvas.height / 2;
          //   const dx = centerX - this.x;
          //   const dy = centerY - this.y;
          //   const dist = Math.hypot(dx, dy);
          // }

          if (this.mode === "toCenter") {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const dx = centerX - this.x;
            const dy = centerY - this.y;
            const dist = Math.hypot(dx, dy);

            const speed = 1.5; // —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∫ —Ü–µ–Ω—Ç—Ä—É

            if (dist > 1) {
              this.dx = (dx / dist) * speed;
              this.dy = (dy / dist) * speed;
              this.x += this.dx;
              this.y += this.dy;
            } else {
              this.dx = 0;
              this.dy = 0;
            }
          } else if (this.mode === "spread") {
            this.x += this.dx;
            this.y += this.dy;

            this.spreadTimer--;
            if (this.spreadTimer <= 0) {
              this.mode = "toCenter";
            }
          }
        }

        moveTo(targetX, targetY, speed = 1.5) {
          const angle = Math.atan2(targetY - this.y, targetX - this.x);
          this.dx = Math.cos(angle) * speed;
          this.dy = Math.sin(angle) * speed;
        }
      }

      const types = ["A", "B", "D", "G"];
      let balls = [];

      function spawnBalls(n = 16) {
        balls = [];
        for (let i = 0; i < n; i++) {
          const type = types[i % types.length];
          let x, y;
          const edge = Math.floor(Math.random() * 4);
          if (edge === 0) {
            x = 0;
            y = Math.random() * canvas.height;
          } else if (edge === 1) {
            x = canvas.width;
            y = Math.random() * canvas.height;
          } else if (edge === 2) {
            x = Math.random() * canvas.width;
            y = 0;
          } else {
            x = Math.random() * canvas.width;
            y = canvas.height;
          }

          const ball = new Ball(x, y, type);

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–π–º–µ—Ä –∞—É—Ä—ã
          this.auraTimer = 0;

          if (playerSelectedBallIds.includes(ball.id)) {
            ball.selectedByPlayer = true;
          }

          ball.moveTo(canvas.width / 2, canvas.height / 2);
          balls.push(ball);
        }
      }

      let startTime = Date.now();

      canvas.addEventListener("click", (e) => {
        // if (Date.now() - startTime > 4000) return; // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 4 —Å–µ–∫—É–Ω–¥—ã
        if (selectedBalls.length >= 4) return; // –°—Ç—Ä–æ–≥–æ 4 —à–∞—Ä–∞
        handleSelection(e.clientX, e.clientY);

        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // handleBallSelection(mouseX, mouseY);

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;

          const dx = mouseX - ball.x;
          const dy = mouseY - ball.y;
          if (Math.sqrt(dx * dx + dy * dy) < ball.radius) {
            ball.selectedByPlayer = true;
            selectedBalls.push(ball);

            // –í–µ—Ä–Ω—ë–º –º–∞—Å—à—Ç–∞–± –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 0.6 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              ball.targetScale = 1;
            }, 600);
            console.log("‚úÖ –í—ã–±—Ä–∞–Ω —à–∞—Ä", ball.id);
            break;
          }
        }
      });

      canvas.addEventListener("touchstart", (e) => {
        // if (Date.now() - startTime > 4000) return; // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 4 —Å–µ–∫—É–Ω–¥—ã
        if (selectedBalls.length >= 4) return; // –°—Ç—Ä–æ–≥–æ 4 —à–∞—Ä–∞

        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const touchX = touch.clientX - rect.left;
        const touchY = touch.clientY - rect.top;
        handleSelection(touch.clientX, touch.clientY);
        handleBallSelection(touchX, touchY);

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;

          const dx = mouseX - ball.x;
          const dy = mouseY - ball.y;
          if (Math.sqrt(dx * dx + dy * dy) < ball.radius) {
            ball.selectedByPlayer = true;
            selectedBalls.push(ball);

            // –í–µ—Ä–Ω—ë–º –º–∞—Å—à—Ç–∞–± –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 0.6 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              ball.targetScale = 1;
            }, 600);
            console.log("‚úÖ –í—ã–±—Ä–∞–Ω —à–∞—Ä", ball.id);
            break;
          }
        }
      });

      let draggingBall = null;

      canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        for (let ball of balls) {
          const dx = mouseX - ball.x;
          const dy = mouseY - ball.y;
          if (
            Math.sqrt(dx * dx + dy * dy) < ball.baseRadius &&
            ball.selectedByPlayer &&
            ball.hp > 0
          ) {
            draggingBall = ball;
            ball.isDragging = true;
            ball.offsetX = dx;
            ball.offsetY = dy;
            break;
          }
        }
      });

      canvas.addEventListener("mousemove", (e) => {
        if (draggingBall) {
          const rect = canvas.getBoundingClientRect();
          draggingBall.x = e.clientX - rect.left - draggingBall.offsetX;
          draggingBall.y = e.clientY - rect.top - draggingBall.offsetY;
        }
      });

      canvas.addEventListener("mouseup", () => {
        if (draggingBall) {
          draggingBall.isDragging = false;
          draggingBall.mode = "toCenter"; // üí° –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ü–µ–Ω—Ç—Ä
          draggingBall.targetScale = 1;
          draggingBall = null;
        }
      });
      canvas.addEventListener("touchstart", (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const touchX = touch.clientX - rect.left;
        const touchY = touch.clientY - rect.top;

        for (let ball of balls) {
          const dx = touchX - ball.x;
          const dy = touchY - ball.y;
          if (
            Math.sqrt(dx * dx + dy * dy) < ball.baseRadius &&
            ball.selectedByPlayer &&
            ball.hp > 0
          ) {
            draggingBall = ball;
            ball.isDragging = true;
            ball.offsetX = dx;
            ball.offsetY = dy;
            break;
          }
        }
      });

      canvas.addEventListener("touchmove", (e) => {
        if (draggingBall) {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          draggingBall.x = touch.clientX - rect.left - draggingBall.offsetX;
          draggingBall.y = touch.clientY - rect.top - draggingBall.offsetY;
        }
      });

      canvas.addEventListener("touchend", () => {
        if (draggingBall) {
          draggingBall.isDragging = false;
          draggingBall = null;
        }
      });

      function detectCollisions() {
        for (let i = 0; i < balls.length; i++) {
          for (let j = i + 1; j < balls.length; j++) {
            const b1 = balls[i];
            const b2 = balls[j];
            const dx = b1.x - b2.x;
            const dy = b1.y - b2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < b1.baseRadius + b2.baseRadius) {
              resolveCollision(b1, b2);
            }
          }
        }
      }

      const playerSelectedBallIds = [];

      function stopGame() {
        roundActive = false;
        selectionPhase = false;
        gameStarted = false;
        enemyTeamMode = false; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º EnemyTeam
        winnerBall = null;
        // playerSelectedBallIds = []; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–º —à–∞—Ä–æ–≤
        // winner = null; // –µ—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        // gameOver = false;
      }

      function checkSelectedBallSurvival(ball) {
        if (
          ball.selectedByPlayer &&
          ball.collisionSurvived >= 2 &&
          !ball.bonusGiven
        ) {
          ball.hp += 10;

          ball.bonusGiven = true; // –ß—Ç–æ–±—ã –±–æ–Ω—É—Å –Ω–µ –¥–∞–≤–∞–ª—Å—è –º–Ω–æ–≥–æ —Ä–∞–∑
        }
        // console.log(`–ë–æ–Ω—É—Å! ${ball.id} –ø–æ–ª—É—á–∏–ª +20 HP`);
        console.log(`–ë–æ–Ω—É—Å! ${ball.type}-${ball.id} –ø–æ–ª—É—á–∏–ª +10 HP`);
      }

      function startGame() {
        // const versionDisplay = document.getElementById("VersionDisplay");
        // console.log(versionDisplay); // –ü—Ä–æ–≤–µ—Ä—å: –Ω–µ null?2
        // if (versionDisplay) {
        //   versionDisplay.classList.add("hidden");
        // }
        // document.getElementById("VersionDisplay").classList.add("hidden");

        updateLevelDisplay();
        playerSelectedBalls.length = 0;
        balls = [];
        selectedBalls = [];
        for (const ball of balls) {
          ball.selectedByPlayer = false;
        }

        spawnBalls();
        enemyTeamMode = false;
        selectionPhase = true;
        selectionTimer = 240;
        roundActive = false;
        regroupTimer = 0;
        gameStarted = true;
        startTime = Date.now();

        console.log(`üöÄ –£—Ä–æ–≤–µ–Ω—å ${currentLevel} ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ 4 —à–∞—Ä–∞.`);

        // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –Ω–∞ —É—Ä–æ–≤–Ω—è—Ö 2 –∏ –≤—ã—à–µ
        // if (!isInitialStart) {
        //   setTimeout(() => {
        //     selectionPhase = false;
        //     roundActive = true;
        //     console.log("üü¢ –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞");
        //   }, 4000);
        // }
      }

      // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã (–ø–æ—Å–ª–µ –ø—Ä–æ–∏–≥—Ä—ã—à–∞)
      function restartGame() {
        isInitialStart = true;
        currentLevel = 1;

        // const restartBtn = document.createElement("button");
        // restartBtn.textContent = "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ";
        // restartBtn.style.position = "absolute";
        // restartBtn.style.top = "50%";
        // restartBtn.style.left = "50%";
        // restartBtn.style.transform = "translate(-50%, -50%)";
        // restartBtn.style.fontSize = "24px";
        // restartBtn.style.padding = "10px 20px";

        restartBtn.remove();
        document.getElementById("startBtn")?.remove();

        const newBtn = document.createElement("button");
        newBtn.id = "startBtn";
        newBtn.textContent = "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É";
        newBtn.style.position = "absolute";
        newBtn.style.top = "50%";
        newBtn.style.left = "50%";
        newBtn.style.transform = "translate(-50%, -50%)";
        newBtn.style.fontSize = "24px";
        newBtn.style.padding = "10px 20px";
        document.body.appendChild(newBtn);

        newBtn.addEventListener("click", () => {
          document.getElementById("VersionDisplay").classList.add("hidden");
          newBtn.remove();
          isInitialStart = false;
          currentLevel = 1;
          startGame();
        });
      }

      // –ü–æ–±–µ–¥–∞ ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å TopScore
      function handleWin() {
        const totalScore = balls
          .filter((b) => b.selectedByPlayer)
          .reduce((sum, b) => sum + b.score, 0);
        // enemyTeamMode = false; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º EnemyTeam

        console.log(`üéâ –ü–æ–±–µ–¥–∞! –û—á–∫–∏: ${totalScore}`);
        const top = Math.max(localStorage.getItem("TopScore") || 0, totalScore);
        localStorage.setItem("TopScore", top);
        const scoreDisplay = document.createElement("div");
        scoreDisplay.textContent = `üèÜ Top Score: ${top}`;
        scoreDisplay.style.position = "absolute";
        scoreDisplay.style.top = "10px";
        scoreDisplay.style.left = "10px";
        scoreDisplay.style.fontSize = "24px";
        scoreDisplay.style.color = "gold";
        document.body.appendChild(scoreDisplay);

        currentLevel++;
        updateLevelDisplay();
        if (currentLevel === 4) {
          console.log("‚û°Ô∏è –£—Ä–æ–≤–µ–Ω—å 4 (–∑–∞–≥–ª—É—à–∫–∞)");
        } else {
          startGame();
        }
      }

      // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞
      function handleLoss() {
        const totalScore = balls.reduce((sum, b) => sum + b.score, 0);
        console.log(`üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—á–∫–∏: ${totalScore}`);
        const top = Math.max(localStorage.getItem("TopScore") || 0, totalScore);
        localStorage.setItem("TopScore", top);
        restartGame();
      }

      function handleBallSelection(x, y) {
        // if (Date.now() - startTime > 4000) return;

        const selectedCount = balls.filter(
          (b) => b.selectedByPlayer && b.hp > 0
        ).length;
        // if (selectedCount >= 4) return; // ‚Üê —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 4 –∂–∏–≤—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞—Ä–∞

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;

          const dx = x - ball.x;
          const dy = y - ball.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < ball.baseRadius + 10) {
            ball.selectedByPlayer = true;
            selectedBalls.push(ball); // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            console.log("‚úÖ –í—ã–±—Ä–∞–Ω —à–∞—Ä", ball.id);
            break;
          }
        }
      }

      function checkGameState() {
        const aliveBalls = balls.filter((b) => b.hp > 0);
        /* console.clear();*/
        balls.forEach((b) => {
          const status = b.hp > 0 ? "–ñ–∏–≤–æ–π" : "–ú–µ—Ä—Ç–≤—ã–π";
          console.log(`ID: ${b.id}, –û—á–∫–∏: ${b.score}, –°—Ç–∞—Ç—É—Å: ${status}`);
        });

        const onlySelectedAlive = aliveBalls.every((b) => b.selectedByPlayer);
        const onlyEnemyTeamAlive = aliveBalls.every(
          (b) => !b.selectedByPlayer && enemyTeamMode
        );

        if (onlySelectedAlive && aliveBalls.length > 0) {
          console.log("üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã.");
          gameOver("win");
          // showEndScreen();
          startGame();
        } else if (onlyEnemyTeamAlive && aliveBalls.length > 0) {
          console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —à–∞—Ä—ã.");
          gameOver("lose");
          // showEndScreen();
        }
      }

      function showEndScreen() {
        // endScreen.style.display = "block";
        stopGame();
      }

      // function gameOver(result) {
      //   roundActive = false;
      //   selectionPhase = false;
      //   gameStarted = false;

      //   if (result === "win") {
      //     const totalScore = balls
      //       .filter((b) => b.hp > 0 && b.selectedByPlayer)
      //       .reduce((sum, b) => sum + b.score, 0);

      //     console.log(`üèÜ –ü–æ–±–µ–¥–∞! –û–±—â–∏–π —Å—á—ë—Ç: ${totalScore} –æ—á–∫–æ–≤.`);
      //     showEndScreen();
      //     endScreen.style.display = "block";
      //     // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      //     showEndMessage(`üèÜ –ü–æ–±–µ–¥–∞! –û–±—â–∏–π —Å—á—ë—Ç: ${totalScore} –æ—á–∫–æ–≤.`);
      //   } else if (result === "lose") {
      //     showEndScreen();
      //     // endScreen.style.display = "block";
      //     console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!");
      //     showEndMessage("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!");
      //   }
      // }
      function createRestartButton() {
        const btn = document.createElement("button");
        btn.textContent = "üîÅ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞";
        btn.style.position = "absolute";
        btn.style.top = "60%";
        btn.style.left = "50%";
        btn.style.transform = "translate(-50%, -50%)";
        btn.style.padding = "10px 20px";
        btn.style.fontSize = "16px";
        document.body.appendChild(btn);

        btn.addEventListener("click", () => {
          document.body.removeChild(btn);
          startGame(); // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤—Å–µ–π –∏–≥—Ä—ã
        });
      }

      let currentLevel = 1;

      function nextLevel() {
        // currentLevel++;

        if (currentLevel === 2) {
          console.log("Level 2 start");
          document.getElementById("VersionDisplay").classList.add("hidden");
          startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
        } else if (currentLevel === 3) {
          console.log("Level 3 start");
          document.getElementById("VersionDisplay").classList.add("hidden");
          startGame();
        } else if (currentLevel === 4) {
          console.log("Level 4 start");
          // –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        }
      }

      function gameOver(result) {
        // document.getElementById("VersionDisplay").classList.remove("hidden");
        document.getElementById("VersionDisplay").classList.remove("hidden");

        enemyTeamMode = false;
        let totalScore = balls.reduce(
          (sum, b) => (b.hp > 0 ? sum + b.score : sum),
          0
        );

        if (result === "win") {
          handleWin();
          console.log(`üéâ –ü–æ–±–µ–¥–∞! –û–±—â–∏–π —Å—á—ë—Ç: ${totalScore}`);
          ctx.fillStyle = "green";
          ctx.font = "20px Arial";
          ctx.fillText(
            `–ü–æ–±–µ–¥–∞! –û—á–∫–∏: ${totalScore}`,
            canvas.width / 2,
            canvas.height / 2
          );

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          let topScore = localStorage.getItem("topScore") || 0;
          if (totalScore > topScore) {
            localStorage.setItem("topScore", totalScore);
          }

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º TopScore
          const saved = localStorage.getItem("topScore");
          ctx.fillStyle = "black";
          ctx.fillText(
            `Top Score: ${saved}`,
            canvas.width / 2,
            canvas.height / 2 + 30
          );

          // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
          nextLevel();
        } else {
          console.log(`üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—á–∫–∏: ${totalScore}`);
          handleLoss();
          ctx.fillStyle = "red";
          ctx.font = "20px Arial";
          ctx.fillText(
            `–ü–æ—Ä–∞–∂–µ–Ω–∏–µ. –û—á–∫–∏: ${totalScore}`,
            canvas.width / 2,
            canvas.height / 2
          );

          let topScore = localStorage.getItem("topScore") || 0;
          if (totalScore > topScore) {
            localStorage.setItem("topScore", totalScore);
          }

          // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
          // createRestartButton();
        }
      }

      function showEndMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.innerText = text;
        messageDiv.style.position = "absolute";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.fontSize = "32px";
        messageDiv.style.fontWeight = "bold";
        messageDiv.style.color = "white";
        messageDiv.style.background = "rgba(0,0,0,0.7)";
        messageDiv.style.padding = "20px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.zIndex = "999";
        document.body.appendChild(messageDiv);
      }

      function checkVictoryOrDefeat() {
        const aliveBalls = balls.filter((b) => b.hp > 0);

        const onlySelectedAlive = aliveBalls.every((b) => b.selectedByPlayer);
        const onlyEnemyTeamAlive = aliveBalls.every(
          (b) => !b.selectedByPlayer && enemyTeamMode
        );

        if (onlySelectedAlive && aliveBalls.length > 0) {
          console.log("üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã.");
          gameOver("win");
        } else if (onlyEnemyTeamAlive && aliveBalls.length > 0) {
          console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —à–∞—Ä—ã.");
          gameOver("lose");
        }
      }

      function resolveCollision(ball1, ball2) {
        if (ball1.isDragging || ball2.isDragging) {
          return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ —à–∞—Ä–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è
        }
        if (ball1.hp <= 0 || ball2.hp <= 0) return;

        // --- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–≤—É—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ---
        if (ball1.selectedByPlayer && ball2.selectedByPlayer) {
          // --- –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –¥–≤—É—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞—Ä–æ–≤ ---
          if (ball1.selectedByPlayer && ball2.selectedByPlayer) {
            // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ –±–µ–∑ —É—Ä–æ–Ω–∞, +10hp
            // ball1.auraTimer = 240; // 4 —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ 60 FPS
            // ball2.auraTimer = 240;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∫–∞–∫ –æ–±—ã—á–Ω–æ
            const dx = ball2.x - ball1.x;
            const dy = ball2.y - ball1.y;
            const distance = Math.hypot(dx, dy);
            // const minDistance = ball2.basebaseRadius + ball1.basebaseRadius;

            // return distance < minDistance;

            if (distance < ball1.baseRadius + ball2.baseRadius) {
              const angle = Math.atan2(dy, dx);
              const force = 3;

              ball1.dx = -Math.cos(angle) * force;
              ball1.dy = -Math.sin(angle) * force;
              ball2.dx = Math.cos(angle) * force;
              ball2.dy = Math.sin(angle) * force;

              ball1.mode = "spread";
              ball2.mode = "spread";
              ball1.spreadTimer = 60;
              ball2.spreadTimer = 60;

              // –ü—Ä–∏–±–∞–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ (–º–∞–∫—Å–∏–º—É–º 100)
              ball1.hp = Math.min(ball1.hp + 20, 200);
              ball2.hp = Math.min(ball2.hp + 20, 200);

              ball1.activateAura(); // –í–∫–ª—é—á–∞–µ–º –∂—ë–ª—Ç—É—é –∞—É—Ä—É
              ball2.activateAura();

              console.log(
                `–í—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã –æ—Ç—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ HP: ${ball1.id}, ${ball2.id}`
              );
            }
            // ball1.activateAura(); // –í–∫–ª—é—á–∞–µ–º –∂—ë–ª—Ç—É—é –∞—É—Ä—É
            // ball2.activateAura();
            return; // –ó–∞–≤–µ—Ä—à–∞–µ–º, —Ç.–∫. –æ–±—ã—á–Ω–æ–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
          }

          return;
        }
        // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏
        const dx = ball2.x - ball1.x;
        const dy = ball2.y - ball1.y;
        const distance = Math.hypot(dx, dy);

        // if (ball1.selectedByPlayer && ball2.selectedByPlayer) {
        //   return; // –ü–æ–º–µ—á–µ–Ω–Ω—ã–µ —à–∞—Ä—ã –Ω–µ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π
        // }

        if (distance < ball1.baseRadius + ball2.baseRadius) {
          // === EnemyTeam —Ä–µ–∂–∏–º ===
          if (!enemyTeamMode) {
            const unselected = balls.filter(
              (b) => !b.selectedByPlayer && b.hp > 0
            );
            if (
              (currentLevel === 1 && unselected.length <= 4) ||
              (currentLevel === 2 && unselected.length <= 6) ||
              (currentLevel === 3 && unselected.length <= 8)
            ) {
              enemyTeamMode = true;
              console.log("EnemyTeam");
            }
          }

          // === EnemyTeam –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ + –∏—Å—Ü–µ–ª–µ–Ω–∏–µ ===
          if (
            enemyTeamMode &&
            !ball1.selectedByPlayer &&
            !ball2.selectedByPlayer &&
            distance < ball1.baseRadius + ball2.baseRadius
          ) {
            const angle = Math.atan2(dy, dx);
            const force = 3;

            ball1.dx = -Math.cos(angle) * force;
            ball1.dy = -Math.sin(angle) * force;
            ball2.dx = Math.cos(angle) * force;
            ball2.dy = Math.sin(angle) * force;

            ball1.mode = "spread";
            ball2.mode = "spread";
            ball1.spreadTimer = 60;
            ball2.spreadTimer = 60;

            ball1.auraColor = "purple";
            ball2.auraColor = "purple";
            ball1.auraTimer = 240; // 4 —Å–µ–∫—É–Ω–¥—ã
            ball2.auraTimer = 240;

            ball1.hp = Math.min(ball1.hp + 40, 200);
            ball2.hp = Math.min(ball2.hp + 40, 200);

            return;
          }

          // --- –£—Ä–æ–Ω ---
          const damage = Math.floor(Math.random() * 20) + 5; // –æ—Ç 5 –¥–æ 25
          ball1.hp -= damage;
          ball2.hp -= damage;

          ball1.collisionSurvived = (ball1.collisionSurvived || 0) + 1;
          ball2.collisionSurvived = (ball2.collisionSurvived || 0) + 1;

          checkSelectedBallSurvival(ball1);
          checkSelectedBallSurvival(ball2);

          // --- –û—á–∫–∏ ---
          ball1.score += 1;
          ball2.score += 1;

          if (ball1.hp <= 0) {
            ball1.hp = 0;
          }
          if (ball2.hp <= 0) {
            ball2.hp = 0;
          }

          // --- –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è ---
          if (ball1.score > ball2.score) {
            ball1.baseRadius += 1;
          } else if (ball2.score > ball1.score) {
            ball2.baseRadius += 1;
          }

          // --- –†–∞—Å—á—ë—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è ---
          const angle = Math.atan2(dy, dx);
          const force = 3;

          ball1.dx = -Math.cos(angle) * force;
          ball1.dy = -Math.sin(angle) * force;
          ball2.dx = Math.cos(angle) * force;
          ball2.dy = Math.sin(angle) * force;

          // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–±–µ–≥–∞–Ω–∏–µ
          ball1.mode = "spread";
          ball2.mode = "spread";
          ball1.spreadTimer = 60;
          ball2.spreadTimer = 60;
        }
        const aliveBalls = balls.filter((b) => b.hp > 0);

        const onlySelectedAlive = aliveBalls.every((b) => b.selectedByPlayer);
        const onlyEnemyTeamAlive = aliveBalls.every(
          (b) => !b.selectedByPlayer && enemyTeamMode
        );

        if (onlySelectedAlive && aliveBalls.length > 0) {
          console.log("üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã.");
          gameOver("win");
        } else if (onlyEnemyTeamAlive && aliveBalls.length > 0) {
          console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —à–∞—Ä—ã.");
          gameOver("lose");
        }
        checkGameState();
      }

      function regroupToCenter() {
        for (let ball of balls) {
          ball.moveTo(canvas.width / 2, canvas.height / 2);
        }
      }

      let roundActive = true;
      let regroupTimer = 0;

      function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let ball of balls) {
          if (this.auraTimer > 0) {
            this.auraTimer--;
          }
          ball.update();
          ball.draw();
        }

        if (!gameStarted) return requestAnimationFrame(gameLoop);

        if (roundActive) {
          detectCollisions();
          if (balls.length <= 1) {
            roundActive = false;
            regroupTimer = 120;
          }
        } else {
          regroupTimer--;
          if (regroupTimer === 60) regroupToCenter();
          if (regroupTimer <= 0 && balls.length > 1) {
            roundActive = true;
          }
        }

        requestAnimationFrame(gameLoop);
      }

      function handleSelection(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        for (const ball of balls) {
          if (ball.selectedByPlayer || selectedBalls.length >= 4) continue;
          const dx = x - ball.x;
          const dy = y - ball.y;
          if (Math.hypot(dx, dy) < ball.baseRadius * 1.5) {
            ball.selectedByPlayer = true;
            ball.targetScale = 2;
            selectedBalls.push(ball);
            // –í–µ—Ä–Ω—ë–º –º–∞—Å—à—Ç–∞–± –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 0.6 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              ball.targetScale = 1;
            }, 600);
            break;
          }
        }
      }

      function handleClick(event) {
        // console.log("hendle");
        const rect = canvas.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const clickY = event.clientY - rect.top;

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;
          // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–µ—Ä—Ç–≤—ã—Ö
          if (selectedBalls.length >= 4) return; // ‚ùó –£–∂–µ –≤—ã–±—Ä–∞–Ω–æ 4 ‚Äî –¥–∞–ª—å—à–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
          const dx = ball.x - clickX;
          const dy = ball.y - clickY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < ball.baseRadius + 5) {
            if (!ball.selectedByPlayer && playerSelectedBalls.length < 4) {
              ball.selectedByPlayer = true;

              playerSelectedBalls.push(ball);
              console.log(`–í—ã –≤—ã–±—Ä–∞–ª–∏ —à–∞—Ä –∏–≥—Ä–æ–∫–∞: ID ${ball.id}`);
            }
            break;
          }
        }
      }

      spawnBalls();
      gameLoop();
      canvas.addEventListener("click", handleClick);
      window.addEventListener("load", () => {
        isInitialStart = false;
        startGame();
      });
    </script>
  </body>
</html>
