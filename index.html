<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
      charset="UTF-8"
    />

    <title>BoomBalls</title>
  </head>
  <body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="ui">
      <button id="startBtn">‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <div id="endScreen" style="display: none">
        <h2 id="endMessage"></h2>
        <button id="restartBtn">üîÅ –°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
      </div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–º–æ—â–∏ -->
    <button id="helpBtn" class="help-button">?</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modalOverlay" class="modal-overlay hidden">
      <div class="modal-slider" id="sliderContainer">
        <div class="slider-content">
          <div class="slider" id="slider">
            <!-- –°–ª–∞–π–¥—ã -->
            <div class="slide">
              <img src="/img/file3.webp" alt="–û–ø–∏—Å–∞–Ω–∏–µ 1" />
              <p>–í—ã–±–µ—Ä–∏ 4 –ª—é–±—ã—Ö —à–∞—Ä–∞, —ç—Ç–æ —Ç–≤–æ—è –∫–æ–º–∞–Ω–¥–∞</p>
            </div>
            <div class="slide">
              <img src="/img/file2.webp" alt="–û–ø–∏—Å–∞–Ω–∏–µ 2" />
              <p>–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ –ø–æ–ª—É—á–∞–µ—Ç HP</p>
            </div>
            <div class="slide">
              <img src="/img/file4.webp" alt="–û–ø–∏—Å–∞–Ω–∏–µ 3" />
              <p>–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —à–∞—Ä—ã —Ç–æ–∂–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –∫–æ–º–∞–Ω–¥—É</p>
            </div>
            <div class="slide">
              <img src="/img/file1.webp" alt="–û–ø–∏—Å–∞–Ω–∏–µ 4" />
              <p>–¢–µ–ø–µ—Ä—å –æ–Ω–∏—Ç–æ–∂–µ –ø–æ–ª—É—á–∞—é—Ç HP</p>
            </div>
            <div class="slide">
              <img src="/img/video1.gif" alt="–û–ø–∏—Å–∞–Ω–∏–µ 4" />
              <p>–¢—ã –º–æ–∂–µ—à—å –ø–µ—Ä–µ–º–µ—â–∞—Ç—å —Å–≤–æ–∏ —à–∞—Ä—ã –≤ –ª—É—á—à–∏–µ –ø–æ–∑–∏—Ü–∏–∏</p>
            </div>
          </div>
        </div>
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <button id="prevBtn" class="nav-button">‚Üê</button>
        <button id="nextBtn" class="nav-button">‚Üí</button>
        <button id="closeBtn" class="close-button">–°–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div id="levelDisplay">Level 1</div>
    <div id="VersionDisplay">"BoomBalls" @IFilkov</div>

    <div id="introContainer">
      <div id="boomWord"></div>
      <div id="ballsWord">Balls</div>
    </div>
    <div id="countdown" class="countdown hidden">9</div>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
        font-family: sans-serif;
        background-color: #eee;
      }
      canvas {
        background-color: #eee;
        display: block;
        margin: auto;
      }
      p {
        font-size: xx-large;
      }

      .countdown {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 120px;
        font-weight: bold;
        color: rgba(0, 0, 0, 0.5);
        z-index: 1;
        pointer-events: none;
      }

      #ui {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #startBtn,
      #restartBtn {
        width: 150px;
        height: 150px;
        font-size: 20px;
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: #4caf50;
        color: white;
        border-radius: 50%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: background 0.3s;
        pointer-events: auto;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .modal-slider {
        background: white;
        border-radius: 12px;
        max-width: 90%;
        width: 100%;
        max-height: 90vh;
        padding: 10px;
        position: relative;
        overflow: hidden;
        box-sizing: border-box;
      }

      .slider-content {
        /* display: flex; */
        width: 100%;
        overflow: hidden;
        position: relative;
      }

      #slider {
        display: flex;
        transition: transform 0.3s ease;
        width: 100%; /* 4 —Å–ª–∞–π–¥–∞ => 4 x 100% */
      }

      .slide {
        flex: 0 0 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 10px;
      }

      .slide img {
        width: 100%;
        height: auto;
        max-height: 60vh;
        border-radius: 10px;
        object-fit: contain;
      }

      .nav-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(200, 200, 200, 0.8);
        border: none;
        padding: 10px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        z-index: 1000;
      }

      #prevBtn {
        left: 10px;
      }
      #nextBtn {
        right: 10px;
      }

      .close-button {
        margin-top: 10px;
        background: red;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
      }

      .hidden {
        display: none;
      }

      .help-button {
        position: fixed;
        bottom: 16px;
        left: 16px;
        background: red;
        color: white;
        border-radius: 50%;
        font-size: 24px;
        width: 44px;
        height: 44px;
        border: none;
        cursor: pointer;
        z-index: 1000;
      }
      #startBtn:hover,
      #restartBtn:hover {
        background: #45a049;
      }

      #startBtn {
        pointer-events: auto;
      }

      #endScreen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        animation: fadeInZoom 0.6s ease forwards;
        pointer-events: auto;
        z-index: 10;
      }

      #endMessage {
        font-size: 28px;
        margin-bottom: 25px;
        color: #333;
        text-align: center;
      }

      #levelDisplay {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 24px;
        font-weight: bold;
        color: #00aaff;
        font-family: sans-serif;
        z-index: 100;
      }
      #VersionDisplay {
        position: fixed;
        bottom: 10px;
        right: -100%; /* –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞ —ç–∫—Ä–∞–Ω–æ–º */
        white-space: nowrap;
        font-family: Arial, sans-serif;
        font-size: 42px;
        color: #00aaff;
        z-index: 9999;
        animation: marquee 10s linear infinite;
        pointer-events: none;
      }

      @keyframes marquee {
        0% {
          right: -100%;
        }
        100% {
          right: 100%;
          transform: translateX(-100vw);
        }
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
      #VersionDisplay.hidden {
        display: none;
      }

      @keyframes fadeInZoom {
        from {
          opacity: 0;
          transform: scale(0.5);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      #introContainer {
        position: absolute;
        top: 20%;
        width: 100%;
        text-align: center;
        z-index: 999;
        pointer-events: none;
      }

      #boomWord {
        font-size: 64px;
        font-weight: bold;
        display: flex;
        justify-content: center;
        position: relative;
        animation: slideInBoom 1.5s ease-out forwards;
        transform: translateX(-100%);
      }

      #ballsWord {
        font-size: 48px;
        color: #00aaff;
        font-weight: bold;
        opacity: 0;
        animation: slideInBalls 1.5s ease-out 1.5s forwards;
        position: relative;
        transform: translateX(100%);
      }

      /* @keyframes slideInBoom {
        to {
          transform: translateX(0);
        }
      }

      @keyframes slideInBalls {
        to {
          transform: translateX(0);
          opacity: 1;
        }
      } */
      /* –í—Ö–æ–¥ */
      @keyframes slideIn {
        0% {
          transform: translateX(var(--start));
          opacity: 0;
        }
        50% {
          transform: translateX(0);
          opacity: 1;
        }
        70% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* –í—ã—Ö–æ–¥ */
      @keyframes slideOut {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: translateX(var(--end));
          opacity: 0;
        }
      }

      .winer {
        font-size: 46px;
      }

      #boomWord {
        font-size: 8vw;
      }
      #ballsWord {
        font-size: 6vw;
      }
    </style>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas(); // —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

      // window.addEventListener("DOMContentLoaded", () => {
      //   const boomColors = ["green", "orange", "purple", "pink"];
      //   const boomText = "Boom";
      //   const boomWord = document.getElementById("boomWord");

      //   // –û—á–∏—Å—Ç–∏–º –Ω–∞ —Å–ª—É—á–∞–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
      //   // boomWord.innerHTML = "";

      //   for (let i = 0; i < boomText.length; i++) {
      //     const span = document.createElement("span");
      //     span.textContent = boomText[i];
      //     span.style.color =
      //       boomColors[Math.floor(Math.random() * boomColors.length)];
      //     span.style.margin = "0 5px";
      //     boomWord.appendChild(span);
      //   }
      // });
      const boomColors = ["green", "orange", "purple", "pink"];
      const boomWord = document.getElementById("boomWord");
      const ballsWord = document.getElementById("ballsWord");
      let introInterval;

      const countdownEl = document.getElementById("countdown");
      let selectionEnabled = true;
      let MAX_SELECTION = 4;
      let baseBallCount = 16; // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
      let currentLevel = 1;

      let TOTAL_BALLS = 16;
      let teamThreshold = 4;

      // function startCountdown() {
      //   let count = 9;
      //   countdownEl.textContent = count;
      //   countdownEl.classList.remove("hidden");

      //   selectionEnabled = true; // ‚úÖ –í–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –æ–¥–∏–Ω —Ä–∞–∑

      //   const interval = setInterval(() => {
      //     count--;
      //     if (count >= 0) {
      //       countdownEl.textContent = count;
      //     } else {
      //       clearInterval(interval);
      //       countdownEl.textContent = "";
      //       selectionEnabled = false; // ‚úÖ –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
      //       console.log("‚è≥ –í—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã –∏—Å—Ç–µ–∫–ª–æ!");
      //     }
      //   }, 1000);
      // }
      function startCountdown() {
        let count = 9;
        countdownEl.textContent = count;
        countdownEl.classList.remove("hidden");

        selectionEnabled = true;

        const interval = setInterval(() => {
          count--;
          if (count >= 0) {
            countdownEl.textContent = count;
          }

          if (count < 0) {
            clearInterval(interval);
            countdownEl.textContent = "";
            selectionEnabled = false;

            console.log("‚è≥ –í—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã –∏—Å—Ç–µ–∫–ª–æ!");

            // üîé –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —É–∂–µ –≤—ã–±—Ä–∞–ª –∏–≥—Ä–æ–∫
            const alreadySelected = playerSelectedBalls.length;
            const needed = MAX_SELECTION - alreadySelected;

            if (needed > 0) {
              const unselected = balls.filter(
                (b) => !b.selectedByPlayer && b.hp > 0
              );

              for (let i = 0; i < needed && i < unselected.length; i++) {
                const ball = unselected[i];
                ball.selectedByPlayer = true;
                playerSelectedBalls.push(ball);
                ball.activateAura(); // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                console.log(`‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω —à–∞—Ä ID: ${ball.id}`);
              }
            }

            console.log(
              "üìã –ò—Ç–æ–≥: –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã:",
              playerSelectedBalls.map((b) => b.id)
            );
          }
        }, 1000);
      }

      function animateIntro() {
        // –û—á–∏—Å—Ç–∏—Ç—å Boom –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å
        boomWord.innerHTML = "";
        boomWord.style.setProperty("--start", "-100vw");
        boomWord.style.setProperty("--end", "100vw");
        boomWord.style.animation = "slideIn 1.5s ease-out forwards";

        // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–∫—Ä–∞—à–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã Boom
        const boomText = "Boom";
        for (let i = 0; i < boomText.length; i++) {
          const span = document.createElement("span");
          span.textContent = boomText[i];
          span.style.color =
            boomColors[Math.floor(Math.random() * boomColors.length)];
          span.style.margin = "0 5px";
          boomWord.appendChild(span);
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è Balls
        ballsWord.style.setProperty("--start", "100vw");
        ballsWord.style.setProperty("--end", "-100vw");
        ballsWord.style.animation = "slideIn 1.5s ease-out 0.3s forwards";

        // –í—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          boomWord.style.animation = "slideOut 1s ease-in forwards";
          ballsWord.style.animation = "slideOut 1s ease-in forwards";
        }, 3000);
      }

      // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ü–∏–∫–ª –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
      window.addEventListener("DOMContentLoaded", () => {
        animateIntro();
        introInterval = setInterval(animateIntro, 4000);
      });

      const startBtn = document.getElementById("startBtn");
      const endScreen = document.getElementById("endScreen");
      const endMessage = document.getElementById("endMessage");
      const restartBtn = document.getElementById("restartBtn");

      let selectionPhase = false;
      let selectionTimer = 240; // 4 —Å–µ–∫—É–Ω–¥—ã
      let gameStarted = false;
      let winnerBall = null;
      let enemyTeamMode = false;
      let isInitialStart = true;

      startBtn.onclick = () => {
        // clearInterval(introInterval);
        document.getElementById("introContainer").style.display = "none";
        startBtn.style.display = "none";
        helpBtn.style.display = "none";
        // helpBtn.style.display = "none";
        document.getElementById("VersionDisplay").classList.add("hidden");
        isInitialStart = false;
        currentLevel === 1;
        startCountdown();
        startGame();
      };

      // helpBtn.onclick = () => {
      //   helpBtn.style.display = "none";
      //   helpModal.classList.remove("hidden");
      // };

      // helpModal.onclick = () => {
      //   helpBtn.style.display = "block";
      //   helpModal.classList.add("hidden");
      // };

      function updateLevelDisplay() {
        document.getElementById(
          "levelDisplay"
        ).textContent = `Level ${currentLevel}`;
      }

      let selectionStartTime = Date.now();
      let selectedBalls = [];
      let playerSelectedBalls = [];

      class Ball {
        constructor(x, y, type) {
          this.x = x;
          this.y = y;
          this.radius = 15;
          this.baseRadius = 15;
          this.scale = 1;
          this.targetScale = 1;
          this.color = this.getColorByType(type);
          this.type = type;
          this.dx = 0;
          this.dy = 0;
          this.score = 0;
          this.id = Math.random().toString(36).substr(2, 9);
          this.hp = 200;
          this.mode = "toCenter"; // –≤–∞—Ä–∏–∞–Ω—Ç—ã: 'toCenter', 'spread'
          this.spreadTimer = 0;
          this.selectedByPlayer = false;
          this.collisionSurvived = 0;
          this.bonusGiven = false;
          this.auraTimer = 0;
          this.auraColor = null;
          this.isDragging = false;
          this.offsetX = 0;
          this.offsetY = 0;
          this.visualRadius = this.baseRadius + this.score * 2;
        }
        activateAura(duration = 400) {
          this.auraTimer = duration;

          // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä —É–º–µ–Ω—å—à–µ–Ω–∏—è
          const interval = setInterval(() => {
            this.auraTimer -= 100;
            if (this.auraTimer <= 0) {
              this.auraTimer = 0;
              clearInterval(interval);
            }
          }, 100);
        }

        getColorByType(type) {
          switch (type) {
            case "A":
              return "green";
            case "B":
              return "orange";
            case "D":
              return "purple";
            case "G":
              return "pink";
          }
        }

        draw() {
          // üåü –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –∞—É—Ä–∞ ‚Äî —Ä–∏—Å—É–µ–º –∂—ë–ª—Ç—É—é –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å
          if (this.auraTimer > 0) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.baseRadius + 5, 0, Math.PI * 2);
            ctx.strokeStyle = this.auraColor || "yellow";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();
          }

          ctx.save(); // üí° –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          ctx.translate(this.x, this.y);
          this.scale += (this.targetScale - this.scale) * 0.1;
          ctx.scale(this.scale, this.scale);

          // –†–∏—Å—É–µ–º —Å–∞–º —à–∞—Ä
          ctx.beginPath();
          ctx.arc(0, 0, this.baseRadius, 0, Math.PI * 2);
          ctx.fillStyle = this.selectedByPlayer ? "lightblue" : this.color;
          ctx.fill();
          ctx.stroke();
          ctx.closePath();

          // üí¨ –≠–º–æ–¥–∑–∏ –ø–æ —à–∫–∞–ª–µ HP
          let emoji = "üôÇ"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          const hpPercent = this.hp / 200;
          if (hpPercent >= 0.5) {
            emoji = "üôÇ";
          } else if (hpPercent >= 0.25) {
            emoji = "üòê";
          } else {
            emoji = "‚òπÔ∏è";
          }

          // –†–∏—Å—É–µ–º —ç–º–æ–¥–∑–∏
          ctx.font = "20px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(emoji, 0, 0);

          // üë• "Team" –Ω–∞–¥ —à–∞—Ä–æ–º
          if (enemyTeamMode && !this.selectedByPlayer && this.hp > 0) {
            ctx.fillStyle = "purple";
            ctx.font = "12px Arial";
            ctx.fillText("Team", 0, -this.baseRadius - 22);
          }

          // üèÖ –û—á–∫–∏
          ctx.fillStyle = "black";
          ctx.font = "10px Arial";
          ctx.fillText(this.score, 0, this.baseRadius + 10);

          // ‚ù§Ô∏è HP –Ω–∞–¥ —à–∞—Ä–æ–º
          ctx.fillStyle = "black";
          ctx.font = "14px Arial";
          ctx.fillText(`‚ù§Ô∏è${this.hp}`, 0, -this.baseRadius - 8);

          ctx.restore(); // üí° –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }

        update() {
          if (this.hp <= 0) return; // –ú—ë—Ä—Ç–≤—ã–π —à–∞—Ä–∏–∫ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è

          balls.forEach((balls) => {
            if (balls.auraTimer > 0) {
              balls.auraTimer--;
            }
          });

          // if (!this.isDragging) {
          //   // –°—Ç—Ä–µ–º–∏—Ç—Å—è –∫ —Ü–µ–Ω—Ç—Ä—É
          //   const centerX = canvas.width / 2;
          //   const centerY = canvas.height / 2;
          //   const dx = centerX - this.x;
          //   const dy = centerY - this.y;
          //   const dist = Math.hypot(dx, dy);
          // }

          if (this.mode === "toCenter") {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const dx = centerX - this.x;
            const dy = centerY - this.y;
            const dist = Math.hypot(dx, dy);

            const speed = 1.5; // —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∫ —Ü–µ–Ω—Ç—Ä—É

            if (dist > 1) {
              this.dx = (dx / dist) * speed;
              this.dy = (dy / dist) * speed;
              this.x += this.dx;
              this.y += this.dy;
            } else {
              this.dx = 0;
              this.dy = 0;
            }
          } else if (this.mode === "spread") {
            this.x += this.dx;
            this.y += this.dy;

            this.spreadTimer--;
            if (this.spreadTimer <= 0) {
              this.mode = "toCenter";
            }
          }
        }

        moveTo(targetX, targetY, speed = 1.5) {
          const angle = Math.atan2(targetY - this.y, targetX - this.x);
          this.dx = Math.cos(angle) * speed;
          this.dy = Math.sin(angle) * speed;
        }
      }

      const types = ["A", "B", "D", "G"];
      let balls = [];

      function spawnBalls(n = baseBallCount) {
        balls = [];
        for (let i = 0; i < n; i++) {
          const type = types[i % types.length];
          let x, y;
          const edge = Math.floor(Math.random() * 4);
          if (edge === 0) {
            x = 0;
            y = Math.random() * canvas.height;
          } else if (edge === 1) {
            x = canvas.width;
            y = Math.random() * canvas.height;
          } else if (edge === 2) {
            x = Math.random() * canvas.width;
            y = 0;
          } else {
            x = Math.random() * canvas.width;
            y = canvas.height;
          }

          const ball = new Ball(x, y, type);

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–π–º–µ—Ä –∞—É—Ä—ã
          this.auraTimer = 0;

          if (playerSelectedBallIds.includes(ball.id)) {
            ball.selectedByPlayer = true;
          }

          ball.moveTo(canvas.width / 2, canvas.height / 2);
          balls.push(ball);
        }
      }

      let startTime = Date.now();

      // canvas.addEventListener("click", (e) => {
      //   // if (!selectionEnabled) return; // –∑–∞–ø—Ä–µ—Ç –ø–æ —Ç–∞–π–º–µ—Ä—É
      //   // if (selectedBalls.length >= MAX_SELECTION) return; // –°—Ç—Ä–æ–≥–æ 4 —à–∞—Ä–∞
      //   if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION) return;

      //   // handleSelection(e.clientX, e.clientY);

      //   const rect = canvas.getBoundingClientRect();
      //   const mouseX = e.clientX - rect.left;
      //   const mouseY = e.clientY - rect.top;

      //   for (const ball of balls) {
      //     if (ball.hp <= 0 || ball.selectedByPlayer) continue;

      //     const dx = mouseX - ball.x;
      //     const dy = mouseY - ball.y;
      //     if (Math.sqrt(dx * dx + dy * dy) < ball.radius) {
      //       ball.selectedByPlayer = true;
      //       // selectedBalls.push(ball);
      //       playerSelectedBalls.push(ball);

      //       // –í–µ—Ä–Ω—ë–º –º–∞—Å—à—Ç–∞–± –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 0.6 —Å–µ–∫—É–Ω–¥—ã
      //       setTimeout(() => {
      //         ball.targetScale = 1;
      //       }, 600);
      //       console.log("‚úÖ –í—ã–±—Ä–∞–Ω —à–∞—Ä", ball.id);
      //       break;
      //     }
      //   }
      // });
      canvas.addEventListener("click", (e) => {
        if (!selectionEnabled || playerSelectedBalls.length >= MAX_SELECTION)
          return;

        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;

          const dx = mouseX - ball.x;
          const dy = mouseY - ball.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < ball.radius + 10) {
            ball.selectedByPlayer = true;
            playerSelectedBalls.push(ball); // –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤
            ball.activateAura();
            ball.targetScale = 1.6;
            setTimeout(() => (ball.targetScale = 1), 200);
            console.log(`üëÜ –í—ã–±—Ä–∞–Ω –≤—Ä—É—á–Ω—É—é: ${ball.id}`);
            break;
          }
        }
      });

      canvas.addEventListener("touchstart", (e) => {
        // if (Date.now() - startTime > 4000) return; // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 4 —Å–µ–∫—É–Ω–¥—ã
        // if (selectedBalls.length >= MAX_SELECTION) return; // –°—Ç—Ä–æ–≥–æ 4 —à–∞—Ä–∞
        if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION) return;

        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const touchX = touch.clientX - rect.left;
        const touchY = touch.clientY - rect.top;
        // handleSelection(touch.clientX, touch.clientY);
        handleBallSelection(touchX, touchY);

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;

          const dx = mouseX - ball.x;
          const dy = mouseY - ball.y;
          if (Math.sqrt(dx * dx + dy * dy) < ball.radius) {
            ball.selectedByPlayer = true;
            // selectedBalls.push(ball);
            playerSelectedBalls.push(ball);

            // –í–µ—Ä–Ω—ë–º –º–∞—Å—à—Ç–∞–± –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 0.6 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              ball.targetScale = 1;
            }, 600);
            console.log("‚úÖ –í—ã–±—Ä–∞–Ω —à–∞—Ä", ball.id);
            break;
          }
        }
      });

      let draggingBall = null;

      canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        for (let ball of balls) {
          const dx = mouseX - ball.x;
          const dy = mouseY - ball.y;
          if (
            Math.sqrt(dx * dx + dy * dy) < ball.baseRadius &&
            ball.selectedByPlayer &&
            ball.hp > 0
          ) {
            draggingBall = ball;
            ball.isDragging = true;
            ball.offsetX = dx;
            ball.offsetY = dy;
            break;
          }
        }
      });

      canvas.addEventListener("mousemove", (e) => {
        if (draggingBall) {
          const rect = canvas.getBoundingClientRect();
          draggingBall.x = e.clientX - rect.left - draggingBall.offsetX;
          draggingBall.y = e.clientY - rect.top - draggingBall.offsetY;
        }
      });

      canvas.addEventListener("mouseup", () => {
        if (draggingBall) {
          draggingBall.isDragging = false;
          draggingBall.mode = "toCenter"; // üí° –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ü–µ–Ω—Ç—Ä
          draggingBall.targetScale = 1;
          draggingBall = null;
        }
      });
      canvas.addEventListener("touchstart", (e) => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const touchX = touch.clientX - rect.left;
        const touchY = touch.clientY - rect.top;

        for (let ball of balls) {
          const dx = touchX - ball.x;
          const dy = touchY - ball.y;
          if (
            Math.sqrt(dx * dx + dy * dy) < ball.baseRadius &&
            ball.selectedByPlayer &&
            ball.hp > 0
          ) {
            draggingBall = ball;
            ball.isDragging = true;
            ball.offsetX = dx;
            ball.offsetY = dy;
            break;
          }
        }
      });

      canvas.addEventListener("touchmove", (e) => {
        if (draggingBall) {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          draggingBall.x = touch.clientX - rect.left - draggingBall.offsetX;
          draggingBall.y = touch.clientY - rect.top - draggingBall.offsetY;
        }
      });

      canvas.addEventListener("touchend", () => {
        if (draggingBall) {
          draggingBall.isDragging = false;
          draggingBall = null;
        }
      });

      function detectCollisions() {
        for (let i = 0; i < balls.length; i++) {
          for (let j = i + 1; j < balls.length; j++) {
            const b1 = balls[i];
            const b2 = balls[j];
            const dx = b1.x - b2.x;
            const dy = b1.y - b2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < b1.baseRadius + b2.baseRadius) {
              resolveCollision(b1, b2);
            }
          }
        }
      }

      const playerSelectedBallIds = [];

      function stopGame() {
        // roundActive = false;
        selectionPhase = false;
        // gameStarted = false;
        enemyTeamMode = false; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º EnemyTeam
        winnerBall = null;
        // playerSelectedBallIds = []; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–º —à–∞—Ä–æ–≤
        // winner = null; // –µ—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        // gameOver = false;
      }

      function checkSelectedBallSurvival(ball) {
        if (
          ball.selectedByPlayer &&
          ball.collisionSurvived >= 2 &&
          !ball.bonusGiven
        ) {
          ball.hp += 10;

          ball.bonusGiven = true; // –ß—Ç–æ–±—ã –±–æ–Ω—É—Å –Ω–µ –¥–∞–≤–∞–ª—Å—è –º–Ω–æ–≥–æ —Ä–∞–∑
        }
        // console.log(`–ë–æ–Ω—É—Å! ${ball.id} –ø–æ–ª—É—á–∏–ª +20 HP`);
        // console.log(`–ë–æ–Ω—É—Å! ${ball.type}-${ball.id} –ø–æ–ª—É—á–∏–ª +10 HP`);
      }
      clearInterval(introInterval);
      function startGame() {
        // const versionDisplay = document.getElementById("VersionDisplay");
        // console.log(versionDisplay); // –ü—Ä–æ–≤–µ—Ä—å: –Ω–µ null?2
        // if (versionDisplay) {
        //   versionDisplay.classList.add("hidden");
        // }
        // document.getElementById("VersionDisplay").classList.add("hidden");
        // clearInterval(introInterval);
        updateLevelDisplay();

        playerSelectedBalls.length = 0;
        balls = [];
        selectedBalls = [];
        for (const ball of balls) {
          ball.selectedByPlayer = false;
        }

        spawnBalls();
        enemyTeamMode = false;
        // selectionEnabled = false;
        selectionPhase = true;
        selectionTimer = 240;
        roundActive = false;
        regroupTimer = 0;
        gameStarted = true;
        startTime = Date.now();
        console.clear();
        console.log(`üöÄ –£—Ä–æ–≤–µ–Ω—å ${currentLevel} ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ 4 —à–∞—Ä–∞.`);
        // document.getElementById("introContainer").style.display = "none";
        // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –Ω–∞ —É—Ä–æ–≤–Ω—è—Ö 2 –∏ –≤—ã—à–µ
        // if (!isInitialStart) {
        //   setTimeout(() => {
        //     selectionPhase = false;
        //     roundActive = true;
        //     console.log("üü¢ –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞");
        //   }, 4000);
        // }
      }

      // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã (–ø–æ—Å–ª–µ –ø—Ä–æ–∏–≥—Ä—ã—à–∞)
      function restartGame() {
        isInitialStart = true;
        currentLevel = 1;

        // const restartBtn = document.createElement("button");
        // restartBtn.textContent = "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ";
        // restartBtn.style.position = "absolute";
        // restartBtn.style.top = "50%";
        // restartBtn.style.left = "50%";
        // restartBtn.style.transform = "translate(-50%, -50%)";
        // restartBtn.style.fontSize = "24px";
        // restartBtn.style.padding = "10px 20px";

        restartBtn.remove();
        document.getElementById("startBtn")?.remove();

        const newBtn = document.createElement("button");
        newBtn.id = "startBtn";
        newBtn.textContent = "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É";
        newBtn.style.position = "absolute";
        newBtn.style.top = "50%";
        newBtn.style.left = "50%";
        newBtn.style.transform = "translate(-50%, -50%)";
        newBtn.style.fontSize = "24px";
        newBtn.style.padding = "10px 20px";
        document.body.appendChild(newBtn);

        newBtn.addEventListener("click", () => {
          startCountdown();
          if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION)
            return;
          MAX_SELECTION = 4;
          baseBallCount = 16;
          document.getElementById("VersionDisplay").classList.add("hidden");
          newBtn.remove();
          helpBtn.style.display = "none";
          document.getElementById("introContainer").style.display = "none";
          isInitialStart = false;
          currentLevel = 1;
          startGame();
        });
      }

      // –ü–æ–±–µ–¥–∞ ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å TopScore
      function handleWin() {
        const totalScore = balls
          .filter((b) => b.selectedByPlayer)
          .reduce((sum, b) => sum + b.score, 0);
        // enemyTeamMode = false; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º EnemyTeam

        console.log(`üéâ –ü–æ–±–µ–¥–∞! –û—á–∫–∏: ${totalScore}`);
        const top = Math.max(localStorage.getItem("TopScore") || 0, totalScore);
        localStorage.setItem("TopScore", top);
        const scoreDisplay = document.createElement("div");
        scoreDisplay.textContent = `üèÜ Top Score: ${top}`;
        scoreDisplay.style.position = "absolute";
        scoreDisplay.style.top = "10px";
        scoreDisplay.style.left = "10px";
        scoreDisplay.style.fontSize = "24px";
        scoreDisplay.style.color = "gold";
        document.body.appendChild(scoreDisplay);

        // currentLevel++;
        updateLevelDisplay();
        // if (currentLevel === 4) {
        //   console.log("‚û°Ô∏è –£—Ä–æ–≤–µ–Ω—å 4 (–∑–∞–≥–ª—É—à–∫–∞)");
        // } else {
        //   startGame();
        // }
      }

      // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞
      function handleLoss() {
        const totalScore = balls.reduce((sum, b) => sum + b.score, 0);
        console.log(`üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—á–∫–∏: ${totalScore}`);
        const top = Math.max(localStorage.getItem("TopScore") || 0, totalScore);
        localStorage.setItem("TopScore", top);
        stopGame();
        restartGame();
      }

      function handleBallSelection(x, y) {
        if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION) return;

        console.log("–Ø –≤—ã–∑—ã–≤–∞—é—Å—å?");
        // if (Date.now() - startTime > 4000) return;

        const selectedCount = balls.filter(
          (b) => b.selectedByPlayer && b.hp > 0
        ).length;
        // if (selectedCount >= 4) return; // ‚Üê —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 4 –∂–∏–≤—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞—Ä–∞

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;

          const dx = x - ball.x;
          const dy = y - ball.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < ball.baseRadius + 10) {
            ball.selectedByPlayer = true;
            selectedBalls.push(ball); // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            console.log("‚úÖ –í—ã–±—Ä–∞–Ω —à–∞—Ä", ball.id);
            break;
          }
        }
      }

      function checkGameState() {
        console.log("checkGameState");
        // const aliveBalls = balls.filter((b) => b.hp > 0);
        // /* console.clear();*/
        // balls.forEach((b) => {
        //   const status = b.hp > 0 ? "–ñ–∏–≤–æ–π" : "–ú–µ—Ä—Ç–≤—ã–π";
        //   // console.log(`ID: ${b.id}, –û—á–∫–∏: ${b.score}, –°—Ç–∞—Ç—É—Å: ${status}`);
        // });

        // const onlySelectedAlive = aliveBalls.every((b) => b.selectedByPlayer);
        // const onlyEnemyTeamAlive = aliveBalls.every(
        //   (b) => !b.selectedByPlayer && enemyTeamMode
        // );
      }

      function showEndScreen() {
        // endScreen.style.display = "block";
        stopGame();
      }

      // function gameOver(result) {
      //   roundActive = false;
      //   selectionPhase = false;
      //   gameStarted = false;

      //   if (result === "win") {
      //     const totalScore = balls
      //       .filter((b) => b.hp > 0 && b.selectedByPlayer)
      //       .reduce((sum, b) => sum + b.score, 0);

      //     console.log(`üèÜ –ü–æ–±–µ–¥–∞! –û–±—â–∏–π —Å—á—ë—Ç: ${totalScore} –æ—á–∫–æ–≤.`);
      //     showEndScreen();
      //     endScreen.style.display = "block";
      //     // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      //     showEndMessage(`üèÜ –ü–æ–±–µ–¥–∞! –û–±—â–∏–π —Å—á—ë—Ç: ${totalScore} –æ—á–∫–æ–≤.`);
      //   } else if (result === "lose") {
      //     showEndScreen();
      //     // endScreen.style.display = "block";
      //     console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!");
      //     showEndMessage("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!");
      //   }
      // }
      function createRestartButton() {
        const btn = document.createElement("button");
        btn.textContent = "üîÅ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞";
        btn.style.position = "absolute";
        btn.style.top = "60%";
        btn.style.left = "50%";
        btn.style.transform = "translate(-50%, -50%)";
        btn.style.padding = "10px 20px";
        btn.style.fontSize = "16px";
        document.body.appendChild(btn);

        btn.addEventListener("click", () => {
          if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION)
            return;

          document.body.removeChild(btn);
          startGame(); // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤—Å–µ–π –∏–≥—Ä—ã
        });
      }

      function nextLevel() {
        currentLevel++;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–æ–≤
        if (currentLevel === 1) {
          baseBallCount = 16;
          MAX_SELECTION = 4;
        } else {
          baseBallCount = 16 + (currentLevel - 1) * 4; // +4 —à–∞—Ä–∏–∫–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
          MAX_SELECTION = 4 + (currentLevel - 1) * 2; // +2 –≤—ã–±–æ—Ä–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
        }

        // UI —Å–∫—Ä—ã—Ç–∏–µ
        document.getElementById("VersionDisplay").classList.add("hidden");
        helpBtn.style.display = "none";
        document.getElementById("introContainer").style.display = "none";

        // –¢–∞–π–º–µ—Ä —Ç–æ–ª—å–∫–æ —Å–æ 2 —É—Ä–æ–≤–Ω—è –∏ –≤—ã—à–µ
        if (currentLevel > 1) {
          startCountdown();
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        startGame();
      }

      // function nextLevel() {
      //   // currentLevel++;
      //   if (currentLevel === 1) {
      //     baseBallCount === 16;

      //     MAX_SELECTION = 4;
      //     // console.log("Level 1 start");
      //     document.getElementById("VersionDisplay").classList.add("hidden");
      //     helpBtn.style.display = "none";
      //     // clearInterval(introInterval);
      //     document.getElementById("introContainer").style.display = "none";
      //     startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
      //   }
      //   if (currentLevel === 2) {
      //     baseBallCount += 4; // ‚Üê –≤–æ—Ç —Ç—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö —à–∞—Ä–æ–≤
      //     MAX_SELECTION = 6;
      //     startCountdown();
      //     // console.log("Level 2 start");
      //     document.getElementById("VersionDisplay").classList.add("hidden");
      //     helpBtn.style.display = "none"; // clearInterval(introInterval);
      //     document.getElementById("introContainer").style.display = "none";
      //     startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
      //   } else if (currentLevel === 3) {
      //     baseBallCount += 8; // ‚Üê –≤–æ—Ç —Ç—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö —à–∞—Ä–æ–≤
      //     MAX_SELECTION = 8;
      //     startCountdown();
      //     // console.log("Level 3 start");
      //     document.getElementById("VersionDisplay").classList.add("hidden");
      //     helpBtn.style.display = "none"; // clearInterval(introInterval);
      //     document.getElementById("introContainer").style.display = "none";
      //     startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
      //   } else if (currentLevel === 4) {
      //     baseBallCount += 8; // ‚Üê –≤–æ—Ç —Ç—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö —à–∞—Ä–æ–≤
      //     MAX_SELECTION = 8;
      //     startCountdown();
      //     document.getElementById("VersionDisplay").classList.add("hidden");
      //     helpBtn.style.display = "none"; // clearInterval(introInterval);
      //     document.getElementById("introContainer").style.display = "none";
      //     startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
      //   } else if (currentLevel === 5) {
      //     baseBallCount += 16; // ‚Üê –≤–æ—Ç —Ç—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö —à–∞—Ä–æ–≤
      //     MAX_SELECTION = 8;
      //     startCountdown();
      //     document.getElementById("VersionDisplay").classList.add("hidden");
      //     helpBtn.style.display = "none"; // clearInterval(introInterval);
      //     document.getElementById("introContainer").style.display = "none";
      //     startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
      //   } else if (currentLevel === 6) {
      //     baseBallCount += 24; // ‚Üê –≤–æ—Ç —Ç—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö —à–∞—Ä–æ–≤
      //     MAX_SELECTION = 10;
      //     startCountdown();
      //     document.getElementById("VersionDisplay").classList.add("hidden");
      //     helpBtn.style.display = "none"; // clearInterval(introInterval);
      //     document.getElementById("introContainer").style.display = "none";
      //     startGame(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É
      //   }
      // }

      function gameOver(result) {
        // document.getElementById("VersionDisplay").classList.remove("hidden");
        document.getElementById("VersionDisplay").classList.remove("hidden");
        // document.getElementById("helpBtn").classList.remove("hidden");
        helpBtn.style.display = "block";
        document.getElementById("introContainer").style.display = "block";

        enemyTeamMode = false;
        let totalScore = balls.reduce(
          (sum, b) => (b.hp > 0 ? sum + b.score : sum),
          0
        );

        if (result === "win") {
          handleWin();
          // console.log(`üéâ –ü–æ–±–µ–¥–∞! –û–±—â–∏–π —Å—á—ë—Ç: ${totalScore}`);
          ctx.fillStyle = "green";
          ctx.font = "20px Arial";
          ctx.fillText(
            `–ü–æ–±–µ–¥–∞! –û—á–∫–∏: ${totalScore}`,
            canvas.width / 2,
            canvas.height / 2
          );

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          let topScore = localStorage.getItem("topScore") || 0;
          if (totalScore > topScore) {
            localStorage.setItem("topScore", totalScore);
          }

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º TopScore
          const saved = localStorage.getItem("topScore");
          ctx.fillStyle = "black";
          ctx.fillText(
            `Top Score: ${saved}`,
            canvas.width / 2,
            canvas.height / 2 + 30
          );

          // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
          nextLevel();
        } else if (result === "lose") {
          // console.log(`üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—á–∫–∏: ${totalScore}`);
          handleLoss();

          ctx.fillStyle = "red";
          ctx.font = "20px Arial";
          ctx.fillText(
            `–ü–æ—Ä–∞–∂–µ–Ω–∏–µ. –û—á–∫–∏: ${totalScore}`,
            canvas.width / 2,
            canvas.height / 2
          );

          let topScore = localStorage.getItem("topScore") || 0;
          if (totalScore > topScore) {
            localStorage.setItem("topScore", totalScore);
          }

          // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
          // createRestartButton();
        } else if (result === "draw") {
          alert("ü§ù –ù–∏—á—å—è! –ù–∏–∫—Ç–æ –Ω–µ –≤—ã–∂–∏–ª.");
          handleLoss();
        }
      }

      function showEndMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.innerText = text;
        messageDiv.style.position = "absolute";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.fontSize = "32px";
        messageDiv.style.fontWeight = "bold";
        messageDiv.style.color = "white";
        messageDiv.style.background = "rgba(0,0,0,0.7)";
        messageDiv.style.padding = "20px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.zIndex = "999";
        document.body.appendChild(messageDiv);
      }

      function resolveCollision(ball1, ball2) {
        if (ball1.isDragging || ball2.isDragging) return;
        if (ball1.hp <= 0 || ball2.hp <= 0) return;

        const dx = ball2.x - ball1.x;
        const dy = ball2.y - ball1.y;
        const distance = Math.hypot(dx, dy);

        // --- –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞—Ä–æ–≤ (–±–µ–∑ —É—Ä–æ–Ω–∞, –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ, –∞—É—Ä–∞) ---
        if (ball1.selectedByPlayer && ball2.selectedByPlayer) {
          if (distance < ball1.baseRadius + ball2.baseRadius) {
            const angle = Math.atan2(dy, dx);
            const force = 3;

            ball1.dx = -Math.cos(angle) * force;
            ball1.dy = -Math.sin(angle) * force;
            ball2.dx = Math.cos(angle) * force;
            ball2.dy = Math.sin(angle) * force;

            ball1.mode = "spread";
            ball2.mode = "spread";
            ball1.spreadTimer = 60;
            ball2.spreadTimer = 60;

            ball1.hp = Math.min(ball1.hp + 20, 200);
            ball2.hp = Math.min(ball2.hp + 20, 200);

            ball1.activateAura();
            ball2.activateAura();

            console.log(
              `–í—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã –æ—Ç—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ HP: ${ball1.id}, ${ball2.id}`
            );
          }
          return;
        }

        if (distance < ball1.baseRadius + ball2.baseRadius) {
          // --- EnemyTeam —Ä–µ–∂–∏–º ---
          if (!enemyTeamMode) {
            const unselected = balls.filter(
              (b) => !b.selectedByPlayer && b.hp > 0
            );
            const thresholds = [4, 6, 8, 10, 12, 14];
            if (
              currentLevel <= thresholds.length &&
              unselected.length <= thresholds[currentLevel - 1]
            ) {
              enemyTeamMode = true;
              console.log("EnemyTeam");
            }
          }

          // --- –ü–æ–≤–µ–¥–µ–Ω–∏–µ EnemyTeam: –∏—Å—Ü–µ–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ ---
          if (
            enemyTeamMode &&
            !ball1.selectedByPlayer &&
            !ball2.selectedByPlayer
          ) {
            const angle = Math.atan2(dy, dx);
            const force = 3;

            ball1.dx = -Math.cos(angle) * force;
            ball1.dy = -Math.sin(angle) * force;
            ball2.dx = Math.cos(angle) * force;
            ball2.dy = Math.sin(angle) * force;

            ball1.mode = "spread";
            ball2.mode = "spread";
            ball1.spreadTimer = 60;
            ball2.spreadTimer = 60;

            ball1.auraColor = "purple";
            ball2.auraColor = "purple";
            ball1.auraTimer = 240;
            ball2.auraTimer = 240;

            ball1.hp = Math.min(ball1.hp + 40, 200);
            ball2.hp = Math.min(ball2.hp + 40, 200);

            return;
          }

          // --- –û—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ ‚Äî –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—Å–µ–≥–¥–∞ ---
          const angle = Math.atan2(dy, dx);
          const force = 3;

          ball1.dx = -Math.cos(angle) * force;
          ball1.dy = -Math.sin(angle) * force;
          ball2.dx = Math.cos(angle) * force;
          ball2.dy = Math.sin(angle) * force;

          ball1.mode = "spread";
          ball2.mode = "spread";
          ball1.spreadTimer = 60;
          ball2.spreadTimer = 60;

          // --- –£—Ä–æ–Ω –∏ –æ—á–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã ---
          if (!selectionEnabled) {
            const damage = Math.floor(Math.random() * 20) + 5;
            ball1.hp = Math.max(0, ball1.hp - damage);
            ball2.hp = Math.max(0, ball2.hp - damage);

            ball1.collisionSurvived = (ball1.collisionSurvived || 0) + 1;
            ball2.collisionSurvived = (ball2.collisionSurvived || 0) + 1;

            checkSelectedBallSurvival(ball1);
            checkSelectedBallSurvival(ball2);

            ball1.score += 1;
            ball2.score += 1;

            if (ball1.hp <= 0) ball1.hp = 0;
            if (ball2.hp <= 0) ball2.hp = 0;

            if (ball1.score > ball2.score) {
              ball1.baseRadius += 1;
            } else if (ball2.score > ball1.score) {
              ball2.baseRadius += 1;
            }

            // --- –ü–æ–±–µ–¥–∞/–ø–æ—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ ---
            const aliveBalls = balls.filter((b) => b.hp > 0);
            const onlySelectedAlive = aliveBalls.every(
              (b) => b.selectedByPlayer
            );
            const onlyEnemyTeamAlive = aliveBalls.every(
              (b) => !b.selectedByPlayer && enemyTeamMode
            );
            const anySelectedAlive = aliveBalls.some((b) => b.selectedByPlayer);

            if (!anySelectedAlive && playerSelectedBalls.length > 0) {
              console.log("‚ùå –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–º —à–∞—Ä—ã –ø–æ–≥–∏–±–ª–∏.");
              gameOver("lose");
              return;
            }

            if (onlySelectedAlive && aliveBalls.length > 0) {
              console.log("üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã.");
              gameOver("win");
            } else if (onlyEnemyTeamAlive && aliveBalls.length > 0) {
              console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —à–∞—Ä—ã.");
              gameOver("lose");
            }
          }
        }
      }

      // function checkVictoryOrDefeat() {
      //   const aliveBalls = balls.filter((b) => b.hp > 0);

      //   const onlySelectedAlive = aliveBalls.every((b) => b.selectedByPlayer);
      //   const onlyEnemyTeamAlive = aliveBalls.every(
      //     (b) => !b.selectedByPlayer && enemyTeamMode
      //   );

      //   if (onlySelectedAlive && aliveBalls.length > 0) {
      //     console.log("üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã.");
      //     gameOver("win");
      //   } else if (onlyEnemyTeamAlive && aliveBalls.length > 0) {
      //     console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —à–∞—Ä—ã.");
      //     gameOver("lose");
      //   }
      // }

      // function resolveCollision(ball1, ball2) {
      //   if (ball1.isDragging || ball2.isDragging) {
      //     return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ —à–∞—Ä–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è
      //   }
      //   if (ball1.hp <= 0 || ball2.hp <= 0) return;

      //   // --- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–≤—É—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ---
      //   if (ball1.selectedByPlayer && ball2.selectedByPlayer) {
      //     // --- –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –¥–≤—É—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞—Ä–æ–≤ ---
      //     if (ball1.selectedByPlayer && ball2.selectedByPlayer) {
      //       // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∫–∞–∫ –æ–±—ã—á–Ω–æ
      //       const dx = ball2.x - ball1.x;
      //       const dy = ball2.y - ball1.y;
      //       const distance = Math.hypot(dx, dy);
      //       // const minDistance = ball2.basebaseRadius + ball1.basebaseRadius;

      //       // return distance < minDistance;

      //       if (distance < ball1.baseRadius + ball2.baseRadius) {
      //         const angle = Math.atan2(dy, dx);
      //         const force = 3;

      //         ball1.dx = -Math.cos(angle) * force;
      //         ball1.dy = -Math.sin(angle) * force;
      //         ball2.dx = Math.cos(angle) * force;
      //         ball2.dy = Math.sin(angle) * force;

      //         ball1.mode = "spread";
      //         ball2.mode = "spread";
      //         ball1.spreadTimer = 60;
      //         ball2.spreadTimer = 60;

      //         // –ü—Ä–∏–±–∞–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ (–º–∞–∫—Å–∏–º—É–º 100)
      //         ball1.hp = Math.min(ball1.hp + 20, 200);
      //         ball2.hp = Math.min(ball2.hp + 20, 200);

      //         ball1.activateAura(); // –í–∫–ª—é—á–∞–µ–º –∂—ë–ª—Ç—É—é –∞—É—Ä—É
      //         ball2.activateAura();

      //         console.log(
      //           `–í—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã –æ—Ç—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ HP: ${ball1.id}, ${ball2.id}`
      //         );
      //       }

      //       return; // –ó–∞–≤–µ—Ä—à–∞–µ–º, —Ç.–∫. –æ–±—ã—á–Ω–æ–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
      //     }

      //     return;
      //   }
      //   // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏
      //   const dx = ball2.x - ball1.x;
      //   const dy = ball2.y - ball1.y;
      //   const distance = Math.hypot(dx, dy);

      //   if (distance < ball1.baseRadius + ball2.baseRadius) {
      //     // === EnemyTeam —Ä–µ–∂–∏–º ===
      //     if (!enemyTeamMode) {
      //       const unselected = balls.filter(
      //         (b) => !b.selectedByPlayer && b.hp > 0
      //       );
      //       if (
      //         (currentLevel === 1 && unselected.length <= 4) ||
      //         (currentLevel === 2 && unselected.length <= 6) ||
      //         (currentLevel === 3 && unselected.length <= 8) ||
      //         (currentLevel === 4 && unselected.length <= 10) ||
      //         (currentLevel === 5 && unselected.length <= 12) ||
      //         (currentLevel === 6 && unselected.length <= 14)
      //       ) {
      //         enemyTeamMode = true;
      //         console.log("EnemyTeam");
      //       }
      //     }

      //     // === EnemyTeam –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ + –∏—Å—Ü–µ–ª–µ–Ω–∏–µ ===
      //     if (
      //       enemyTeamMode &&
      //       !ball1.selectedByPlayer &&
      //       !ball2.selectedByPlayer &&
      //       distance < ball1.baseRadius + ball2.baseRadius
      //     ) {
      //       const angle = Math.atan2(dy, dx);
      //       const force = 3;

      //       ball1.dx = -Math.cos(angle) * force;
      //       ball1.dy = -Math.sin(angle) * force;
      //       ball2.dx = Math.cos(angle) * force;
      //       ball2.dy = Math.sin(angle) * force;

      //       ball1.mode = "spread";
      //       ball2.mode = "spread";
      //       ball1.spreadTimer = 60;
      //       ball2.spreadTimer = 60;

      //       ball1.auraColor = "purple";
      //       ball2.auraColor = "purple";
      //       ball1.auraTimer = 240; // 4 —Å–µ–∫—É–Ω–¥—ã
      //       ball2.auraTimer = 240;

      //       ball1.hp = Math.min(ball1.hp + 40, 200);
      //       ball2.hp = Math.min(ball2.hp + 40, 200);

      //       return;
      //     }

      //     // --- –£—Ä–æ–Ω ---
      //     const damage = Math.floor(Math.random() * 20) + 5; // –æ—Ç 5 –¥–æ 25
      //     ball1.hp = Math.max(0, ball1.hp - damage);
      //     ball2.hp = Math.max(0, ball2.hp - damage);

      //     ball1.collisionSurvived = (ball1.collisionSurvived || 0) + 1;
      //     ball2.collisionSurvived = (ball2.collisionSurvived || 0) + 1;

      //     checkSelectedBallSurvival(ball1);
      //     checkSelectedBallSurvival(ball2);

      //     // --- –û—á–∫–∏ ---
      //     ball1.score += 1;
      //     ball2.score += 1;

      //     if (ball1.hp <= 0) {
      //       ball1.hp = 0;
      //     }
      //     if (ball2.hp <= 0) {
      //       ball2.hp = 0;
      //     }

      //     // --- –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è ---
      //     if (ball1.score > ball2.score) {
      //       ball1.baseRadius += 1;
      //     } else if (ball2.score > ball1.score) {
      //       ball2.baseRadius += 1;
      //     }

      //     // --- –†–∞—Å—á—ë—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è ---
      //     const angle = Math.atan2(dy, dx);
      //     const force = 3;

      //     ball1.dx = -Math.cos(angle) * force;
      //     ball1.dy = -Math.sin(angle) * force;
      //     ball2.dx = Math.cos(angle) * force;
      //     ball2.dy = Math.sin(angle) * force;

      //     // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–±–µ–≥–∞–Ω–∏–µ
      //     ball1.mode = "spread";
      //     ball2.mode = "spread";
      //     ball1.spreadTimer = 60;
      //     ball2.spreadTimer = 60;
      //   }

      //   const aliveBalls = balls.filter((b) => b.hp > 0);
      //   const onlySelectedAlive = aliveBalls.every((b) => b.selectedByPlayer);
      //   const onlyEnemyTeamAlive = aliveBalls.every(
      //     (b) => !b.selectedByPlayer && enemyTeamMode
      //   );
      //   const anySelectedAlive = aliveBalls.some((b) => b.selectedByPlayer);

      //   // üî• –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –µ—Å–ª–∏ –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–º –º–µ—Ä—Ç–≤—ã
      //   if (!anySelectedAlive && playerSelectedBalls.length > 0) {
      //     console.log("‚ùå –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–º —à–∞—Ä—ã –ø–æ–≥–∏–±–ª–∏.");
      //     gameOver("lose");
      //     return;
      //   }

      //   if (onlySelectedAlive && aliveBalls.length > 0) {
      //     console.log("üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞—Ä—ã.");
      //     gameOver("win");
      //   } else if (onlyEnemyTeamAlive && aliveBalls.length > 0) {
      //     console.log("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞–∂–µ—Å–∫–∏–µ —à–∞—Ä—ã.");
      //     gameOver("lose");
      //   }

      //   // checkGameState();
      // }

      function regroupToCenter() {
        for (let ball of balls) {
          ball.moveTo(canvas.width / 2, canvas.height / 2);
        }
      }

      let roundActive = true;
      let regroupTimer = 0;

      function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let ball of balls) {
          if (this.auraTimer > 0) {
            this.auraTimer--;
          }
          ball.update();
          ball.draw();
        }

        if (!gameStarted) return requestAnimationFrame(gameLoop);

        if (roundActive) {
          detectCollisions();
          if (balls.length <= 1) {
            roundActive = false;
            regroupTimer = 120;
          }
        } else {
          regroupTimer--;
          if (regroupTimer === 60) regroupToCenter();
          if (regroupTimer <= 0 && balls.length > 1) {
            roundActive = true;
          }
        }

        requestAnimationFrame(gameLoop);
      }

      function handleSelection(clientX, clientY) {
        if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION) return;

        // if (!selectionEnabled) return; // –∑–∞–ø—Ä–µ—Ç –ø–æ —Ç–∞–π–º–µ—Ä—É
        console.log("comon");
        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        for (const ball of balls) {
          // if (ball.selectedByPlayer || selectedBalls.length >= MAX_SELECTION)
          //   continue;
          const dx = x - ball.x;
          const dy = y - ball.y;

          if (Math.hypot(dx, dy) < ball.baseRadius * 1.5) {
            ball.selectedByPlayer = true;
            ball.targetScale = 2;
            selectedBalls.push(ball);
            // –í–µ—Ä–Ω—ë–º –º–∞—Å—à—Ç–∞–± –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 0.6 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              ball.targetScale = 1;
            }, 600);
            break;
          }
        }
      }

      function handleClick(event) {
        if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION) return;

        // console.log("hendle");
        const rect = canvas.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const clickY = event.clientY - rect.top;

        for (const ball of balls) {
          if (ball.hp <= 0 || ball.selectedByPlayer) continue;
          // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–µ—Ä—Ç–≤—ã—Ö
          if (selectedBalls.length >= MAX_SELECTION) return; // ‚ùó –£–∂–µ –≤—ã–±—Ä–∞–Ω–æ 4 ‚Äî –¥–∞–ª—å—à–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
          const dx = ball.x - clickX;
          const dy = ball.y - clickY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < ball.baseRadius + 5) {
            if (!ball.selectedByPlayer && playerSelectedBalls.length < 4) {
              ball.selectedByPlayer = true;

              playerSelectedBalls.push(ball);
              console.log(`–í—ã –≤—ã–±—Ä–∞–ª–∏ —à–∞—Ä –∏–≥—Ä–æ–∫–∞: ID ${ball.id}`);
            }
            break;
          }
        }
      }
      const helpBtn = document.getElementById("helpBtn");
      const modalOverlay = document.getElementById("modalOverlay");
      const closeBtn = document.getElementById("closeBtn");
      const slider = document.getElementById("slider");
      const slides = slider.querySelectorAll(".slide");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      let currentSlide = 0;

      function updateSlider() {
        slider.style.transform = `translateX(-${currentSlide * 100}%)`;
      }

      helpBtn.addEventListener("click", () => {
        helpBtn.classList.add("hidden");
        helpBtn.style.display = "none";
        modalOverlay.classList.remove("hidden");
        updateSlider();
      });

      closeBtn.addEventListener("click", () => {
        modalOverlay.classList.add("hidden");
        helpBtn.style.display = "block";
      });

      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          modalOverlay.classList.remove("hidden");
          helpBtn.style.display = "none";
        }
      });

      prevBtn.addEventListener("click", () => {
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        updateSlider();
      });

      nextBtn.addEventListener("click", () => {
        currentSlide = (currentSlide + 1) % slides.length;
        updateSlider();
      });

      // –°–≤–∞–π–ø—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
      let startX = 0;
      let endX = 0;
      const swipeThreshold = 50;

      slider.addEventListener(
        "touchstart",
        (e) => {
          startX = e.touches[0].clientX;
        },
        { passive: true }
      );

      slider.addEventListener(
        "touchmove",
        (e) => {
          endX = e.touches[0].clientX;
        },
        { passive: true }
      );

      slider.addEventListener("touchend", () => {
        const deltaX = endX - startX;
        if (Math.abs(deltaX) > swipeThreshold) {
          if (deltaX > 0) {
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
          } else {
            currentSlide = (currentSlide + 1) % slides.length;
          }
          updateSlider();
        }
        startX = endX = 0;
      });
      // –ö–ª–∏–∫ –≤–Ω–µ —Å–ª–∞–π–¥–µ—Ä–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          helpBtn.classList.remove("hidden");
          helpBtn.style.display = "block";
          modalOverlay.classList.add("hidden");
        }
      });
      spawnBalls();
      gameLoop();
      canvas.addEventListener("click", handleClick);
      window.addEventListener("load", () => {
        // if (!selectionEnabled || selectedBalls.length >= MAX_SELECTION) return;

        isInitialStart = false;
        startGame();
      });
    </script>
  </body>
</html>
